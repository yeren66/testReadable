<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æäº¤åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 6px; }
        .test-section h3 { margin-top: 0; color: #007bff; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š æäº¤åŠŸèƒ½æµ‹è¯•é¡µé¢</h1>
        
        <div class="test-section">
            <h3>ğŸ”§ æµ‹è¯•åœºæ™¯</h3>
            <button class="btn-primary" onclick="testEmptySubmission()">æµ‹è¯•ç©ºæäº¤</button>
            <button class="btn-warning" onclick="testPartialSubmission()">æµ‹è¯•éƒ¨åˆ†è¯„åˆ†æäº¤</button>
            <button class="btn-success" onclick="testCompleteSubmission()">æµ‹è¯•å®Œæ•´è¯„åˆ†æäº¤</button>
            <button class="btn-danger" onclick="clearData()">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ å½“å‰çŠ¶æ€</h3>
            <div id="currentStatus"></div>
            <button class="btn-primary" onclick="checkStatus()">æ£€æŸ¥çŠ¶æ€</button>
        </div>

        <div class="test-section">
            <h3>ğŸš€ æäº¤æµ‹è¯•</h3>
            <button class="btn-success" onclick="testSubmission()">æ‰§è¡Œæäº¤æµ‹è¯•</button>
            <div id="submissionResult"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ æ—¥å¿—</h3>
            <div id="logOutput"></div>
            <button class="btn-primary" onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿè¯„ä¼°åº”ç”¨çš„æ ¸å¿ƒåŠŸèƒ½
        class TestEvaluationApp {
            constructor() {
                this.evaluationData = JSON.parse(localStorage.getItem('evaluationData') || '{}');
                this.methodToolMappings = JSON.parse(localStorage.getItem('methodToolMappings') || '{}');
                this.testMethods = [
                    { name: 'chart_compareTo' },
                    { name: 'chart_createWindPlot' },
                    { name: 'chart_getHeight' }
                ];
            }

            // æ£€æŸ¥æœªè¯„åˆ†çš„æ–¹æ³•
            checkUnevaluatedMethods() {
                const unevaluatedMethods = [];
                
                for (const method of this.testMethods) {
                    const methodData = this.evaluationData[method.name];
                    if (!methodData) {
                        unevaluatedMethods.push(method.name);
                        continue;
                    }
                    
                    const toolMapping = this.methodToolMappings[method.name];
                    if (!toolMapping) {
                        unevaluatedMethods.push(method.name);
                        continue;
                    }
                    
                    let hasIncompleteEvaluation = false;
                    for (const toolId in toolMapping) {
                        const toolData = methodData[toolId];
                        if (!toolData || Object.keys(toolData).length === 0) {
                            hasIncompleteEvaluation = true;
                            break;
                        }
                        
                        const requiredCriteria = ['naming', 'layout', 'assertion', 'migration'];
                        for (const criterion of requiredCriteria) {
                            if (!toolData[criterion] || toolData[criterion] === 0) {
                                hasIncompleteEvaluation = true;
                                break;
                            }
                        }
                        if (hasIncompleteEvaluation) break;
                    }
                    
                    if (hasIncompleteEvaluation) {
                        unevaluatedMethods.push(method.name);
                    }
                }
                
                return unevaluatedMethods;
            }

            // æäº¤è¯„åˆ†
            async submitEvaluation() {
                if (Object.keys(this.evaluationData).length === 0) {
                    throw new Error('è¯·å…ˆå®Œæˆä¸€äº›è¯„åˆ†å†æäº¤ï¼');
                }

                const unevaluatedMethods = this.checkUnevaluatedMethods();
                if (unevaluatedMethods.length > 0) {
                    let message = `è¿˜æœ‰ ${unevaluatedMethods.length} ä¸ªæ–¹æ³•æœªå®Œæˆè¯„åˆ†ï¼š\n\n`;
                    
                    if (unevaluatedMethods.length <= 3) {
                        message += unevaluatedMethods.map(name => `â€¢ ${name}`).join('\n');
                    } else {
                        message += unevaluatedMethods.slice(0, 3).map(name => `â€¢ ${name}`).join('\n');
                        message += `\n... è¿˜æœ‰ ${unevaluatedMethods.length - 3} ä¸ªæ–¹æ³•`;
                    }
                    
                    message += '\n\næ˜¯å¦ç»§ç»­æäº¤å·²å®Œæˆçš„è¯„åˆ†ï¼Ÿ';
                    
                    if (!confirm(message)) {
                        throw new Error('ç”¨æˆ·å–æ¶ˆæäº¤');
                    }
                }

                const submissionData = {
                    evaluationData: this.evaluationData,
                    methodToolMappings: this.methodToolMappings,
                    metadata: {
                        totalMethods: this.testMethods.length,
                        evaluatedMethods: Object.keys(this.evaluationData).length,
                        unevaluatedMethods: unevaluatedMethods.length,
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent
                    }
                };

                const response = await fetch('/api/submit-evaluation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(submissionData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'æäº¤å¤±è´¥');
                }

                return result;
            }
        }

        const app = new TestEvaluationApp();

        function log(message) {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            logOutput.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function clearLog() {
            document.getElementById('logOutput').innerHTML = '';
        }

        function testEmptySubmission() {
            app.evaluationData = {};
            app.methodToolMappings = {};
            localStorage.setItem('evaluationData', '{}');
            localStorage.setItem('methodToolMappings', '{}');
            log('âœ… è®¾ç½®ä¸ºç©ºæäº¤çŠ¶æ€');
            checkStatus();
        }

        function testPartialSubmission() {
            app.evaluationData = {
                'chart_compareTo': {
                    'Tool_1': { naming: 3, layout: 2, assertion: 3, migration: 2 }
                }
            };
            app.methodToolMappings = {
                'chart_compareTo': { 'Tool_1': 'Method_A', 'Tool_2': 'Method_B' }
            };
            localStorage.setItem('evaluationData', JSON.stringify(app.evaluationData));
            localStorage.setItem('methodToolMappings', JSON.stringify(app.methodToolMappings));
            log('âœ… è®¾ç½®ä¸ºéƒ¨åˆ†è¯„åˆ†çŠ¶æ€ï¼ˆåªæœ‰1ä¸ªæ–¹æ³•éƒ¨åˆ†å®Œæˆï¼‰');
            checkStatus();
        }

        function testCompleteSubmission() {
            app.evaluationData = {
                'chart_compareTo': {
                    'Tool_1': { naming: 3, layout: 2, assertion: 3, migration: 2 },
                    'Tool_2': { naming: 2, layout: 3, assertion: 2, migration: 3 }
                },
                'chart_createWindPlot': {
                    'Tool_1': { naming: 1, layout: 1, assertion: 1, migration: 1 },
                    'Tool_2': { naming: 2, layout: 2, assertion: 2, migration: 2 }
                },
                'chart_getHeight': {
                    'Tool_1': { naming: 3, layout: 3, assertion: 3, migration: 3 },
                    'Tool_2': { naming: 1, layout: 2, assertion: 1, migration: 2 }
                }
            };
            app.methodToolMappings = {
                'chart_compareTo': { 'Tool_1': 'Method_A', 'Tool_2': 'Method_B' },
                'chart_createWindPlot': { 'Tool_1': 'Method_C', 'Tool_2': 'Method_D' },
                'chart_getHeight': { 'Tool_1': 'Method_A', 'Tool_2': 'Method_C' }
            };
            localStorage.setItem('evaluationData', JSON.stringify(app.evaluationData));
            localStorage.setItem('methodToolMappings', JSON.stringify(app.methodToolMappings));
            log('âœ… è®¾ç½®ä¸ºå®Œæ•´è¯„åˆ†çŠ¶æ€ï¼ˆæ‰€æœ‰æ–¹æ³•éƒ½å·²å®Œæˆï¼‰');
            checkStatus();
        }

        function clearData() {
            localStorage.removeItem('evaluationData');
            localStorage.removeItem('methodToolMappings');
            app.evaluationData = {};
            app.methodToolMappings = {};
            log('ğŸ—‘ï¸ å·²æ¸…é™¤æ‰€æœ‰æ•°æ®');
            checkStatus();
        }

        function checkStatus() {
            const unevaluated = app.checkUnevaluatedMethods();
            const total = app.testMethods.length;
            const evaluated = total - unevaluated.length;
            const completion = ((evaluated / total) * 100).toFixed(1);

            const statusDiv = document.getElementById('currentStatus');
            statusDiv.innerHTML = `
                <div class="status info">
                    <strong>è¯„åˆ†çŠ¶æ€:</strong><br>
                    æ€»æ–¹æ³•æ•°: ${total}<br>
                    å·²å®Œæˆ: ${evaluated}<br>
                    æœªå®Œæˆ: ${unevaluated.length}<br>
                    å®Œæˆåº¦: ${completion}%<br>
                    ${unevaluated.length > 0 ? `<br><strong>æœªå®Œæˆæ–¹æ³•:</strong><br>${unevaluated.join(', ')}` : ''}
                </div>
            `;
            log(`ğŸ“Š çŠ¶æ€æ£€æŸ¥: ${evaluated}/${total} å®Œæˆ (${completion}%)`);
        }

        async function testSubmission() {
            const resultDiv = document.getElementById('submissionResult');
            resultDiv.innerHTML = '<div class="status info">æäº¤ä¸­...</div>';
            
            try {
                const result = await app.submitEvaluation();
                resultDiv.innerHTML = `
                    <div class="status success">
                        <strong>âœ… æäº¤æˆåŠŸ!</strong><br>
                        æäº¤ID: ${result.submissionId}<br>
                        æ—¶é—´: ${new Date(result.timestamp).toLocaleString()}<br>
                        æ¶ˆæ¯: ${result.message}
                    </div>
                `;
                log(`âœ… æäº¤æˆåŠŸ: ${result.submissionId}`);
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="status error">
                        <strong>âŒ æäº¤å¤±è´¥!</strong><br>
                        é”™è¯¯: ${error.message}
                    </div>
                `;
                log(`âŒ æäº¤å¤±è´¥: ${error.message}`);
            }
        }

        // åˆå§‹åŒ–
        checkStatus();
        log('ğŸš€ æµ‹è¯•é¡µé¢å·²åŠ è½½');
    </script>
</body>
</html>
